# 家族用 ToDo アプリ - AWS サーバーレス版 要件定義書

## はじめに

本プロジェクトは、Rust + React/TypeScript で実装する家族用 ToDo 共有アプリを、低コスト・高セキュリティで AWS サーバーレスにデプロイするシステムです。イベントソーシングアーキテクチャを採用し、シンプルな UI/UX を実現します。

## 要件

### 要件 1: ToDo 基本管理機能

**ユーザーストーリー:** 家族メンバーとして、ToDo を作成・編集・完了・削除できるようにしたい。そうすることで、家族間でタスクを共有し、効率的に管理できる。

#### 受入基準

1. WHEN ユーザーが ToDo 作成フォームに必要な情報を入力 THEN システムは新しい ToDo を作成し、ULID ベースの ID を割り当てる
2. WHEN ユーザーが既存の ToDo を編集 THEN システムは楽観的ロックを使用して同時編集を制御する
3. WHEN ユーザーが ToDo を完了マーク THEN システムは ToDo の状態を完了に変更し、アクティブリストから除外する
4. WHEN ユーザーが ToDo を削除 THEN システムは論理削除イベントを記録し、物理的なデータは保持する
5. IF ToDo のタイトルが空または 200 文字を超える THEN システムはバリデーションエラーを返す

### 要件 2: イベントソーシングによる履歴管理

**ユーザーストーリー:** システム管理者として、すべての ToDo 操作の完全な履歴を追跡したい。そうすることで、監査証跡を提供し、データの整合性を保証できる。

#### 受入基準

1. WHEN 任意の ToDo 操作が実行される THEN システムは対応するイベントを DynamoDB に永続化する
2. WHEN イベントが保存される THEN システムは ULID を使用して時系列順を保証する
3. WHEN プロジェクション更新が必要 THEN システムは DynamoDB Streams を通じて非同期で処理する
4. WHEN イベント数が 100 を超える OR 最後のスナップショットから 7 日経過 THEN システムは自動的にスナップショットを作成する
5. IF イベント処理が失敗 THEN システムは SQS DLQ にメッセージを送信し、リトライ可能エラーは再試行する

### 要件 3: 家族メンバー管理

**ユーザーストーリー:** 家族の管理者として、家族メンバーを招待し、権限を管理したい。そうすることで、適切なアクセス制御を実現できる。

#### 受入基準

1. WHEN 管理者が新しいメンバーを招待 THEN システムは招待トークンを生成し、有効期限付きで DynamoDB に保存する
2. WHEN 招待メールが送信される THEN システムは SES を使用してセキュアな招待リンクを送信する
3. WHEN 招待されたユーザーが登録 THEN システムは Cognito ユーザープールに追加し、適切な家族グループに割り当てる
4. WHEN メンバーが ToDo にアクセス THEN システムは家族 ID ベースでアクセス制御を実行する
5. IF 招待トークンが期限切れ THEN システムは TTL を使用して自動的にレコードを削除する

### 要件 4: 認証・認可システム

**ユーザーストーリー:** ユーザーとして、パスワードレスで安全にログインしたい。そうすることで、セキュリティを向上させながら利便性を保てる。

#### 受入基準

1. WHEN ユーザーがログインを試行 THEN システムは Passkey（WebAuthn）による認証を提供する
2. WHEN 認証が成功 THEN システムは JWT トークンとリフレッシュトークンを発行する
3. WHEN API リクエストが送信される THEN システムは API Gateway で JWT 検証を実行する
4. WHEN トークンが期限切れ THEN システムはリフレッシュトークンを使用して自動更新する
5. IF 不正なアクセスが検出される THEN システムはアクセスを拒否し、ログに記録する

### 要件 5: リアルタイム同期とパフォーマンス

**ユーザーストーリー:** 家族メンバーとして、他のメンバーの ToDo 変更をリアルタイムで確認したい。そうすることで、重複作業を避け、効率的に協力できる。

#### 受入基準

1. WHEN ToDo が更新される THEN システムは 200ms 以内（p95）でレスポンスを返す
2. WHEN 複数ユーザーが同時アクセス THEN システムは楽観的ロックで整合性を保つ
3. WHEN DynamoDB 操作が実行される THEN システムは読み取り 10ms、書き込み 20ms 以内で完了する
4. WHEN エラーが発生 THEN システムはエラー率 0.1%未満を維持する
5. IF Lambda 関数がコールドスタート THEN システムは 500ms 以内（p99）でレスポンスを返す

### 要件 6: データ保護と GDPR 対応

**ユーザーストーリー:** データ主体として、自分の個人データの削除を要求したい。そうすることで、プライバシー権を行使できる。

#### 受入基準

1. WHEN ユーザーがデータ削除を要求 THEN システムは物理削除（Hard Delete）を実行する
2. WHEN 物理削除が実行される THEN システムはすべてのイベント、プロジェクション、スナップショットを削除する
3. WHEN 削除が完了 THEN システムは匿名化された監査ログを記録する
4. WHEN 通常の削除操作 THEN システムは論理削除（Soft Delete）でイベントとして記録する
5. IF 削除対象データが見つからない THEN システムは適切なエラーメッセージを返す

### 要件 7: 監視・可観測性

**ユーザーストーリー:** システム運用者として、アプリケーションの健全性とパフォーマンスを監視したい。そうすることで、問題を早期発見し、SLO を維持できる。

#### 受入基準

1. WHEN システムが稼働 THEN OpenTelemetry を使用して分散トレーシングを実行する
2. WHEN メトリクスが収集される THEN CloudWatch で可用性 99.9%以上を監視する
3. WHEN エラーが発生 THEN X-Ray トレースで根本原因を特定できる
4. WHEN アラート条件に達する THEN CloudWatch アラームが適切な通知を送信する
5. IF パフォーマンス劣化が検出される THEN システムは自動的にスケーリングまたはアラートを実行する

### 要件 8: インフラストラクチャとデプロイメント

**ユーザーストーリー:** 開発者として、一貫性のあるインフラストラクチャを自動でデプロイしたい。そうすることで、環境差異を排除し、信頼性の高いリリースを実現できる。

#### 受入基準

1. WHEN コードが main ブランチにプッシュされる THEN GitHub Actions が自動的にビルドとテストを実行する
2. WHEN テストが成功 THEN SAM を使用して AWS リソースを自動デプロイする
3. WHEN デプロイが完了 THEN スモークテストが自動実行される
4. WHEN インフラ変更が必要 THEN IaC テンプレートを更新してバージョン管理する
5. IF デプロイが失敗 THEN システムは自動的にロールバックを実行する
